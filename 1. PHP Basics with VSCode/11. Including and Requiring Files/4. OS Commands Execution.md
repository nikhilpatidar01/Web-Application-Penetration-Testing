
# 🖥️ PHP OS Commands Execution

PHP provides built-in functions to execute **Operating System (OS) commands** directly from a script. This can be helpful for system-level tasks like checking server status, manipulating files, or fetching user information.

🔗 **Official PHP Manual**: [System Program Execution](https://www.php.net/manual/en/ref.exec.php)

> ⚠️ **Security Warning**:
> Never trust user input directly in OS command functions. Always sanitize/validate input to prevent command injection vulnerabilities.

---

## 📄 Example Script: `os-commands.php`
```
os-commands.php
```
```php
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PHP OS Command Functions</title>
</head>
<body>
<h2>OS Command Execution in PHP</h2>
<pre>
<?php

// Base command
$cmd = "id";

// 1. passthru() — Executes and displays raw output
echo "Output using passthru():\n";
passthru($cmd);
echo "\n\n";

/*
// 2. system() — Outputs line by line and returns last line
echo "Output using system():\n";
$lastLine = system($cmd, $retval);
echo "\nLast line: $lastLine\nReturn value: $retval\n\n";

// 3. exec() — Returns last line or full array
echo "Output using exec():\n";
exec($cmd, $output);
print_r($output);
echo "\n\n";

// 4. shell_exec() — Returns entire output as string
echo "Output using shell_exec():\n";
echo shell_exec($cmd);
echo "\n\n";

// 5. Backticks — Same as shell_exec()
echo "Output using backticks:\n";
echo `id`;
echo "\n\n";

// 6. popen() + fread() — Reads process output like file
echo "Output using popen():\n";
$fp = popen($cmd, "r");
$read = fread($fp, 2096);
echo $read;
pclose($fp);
echo "\n\n";

// 7. escapeshellarg() — Safely escapes input argument
echo "Using escapeshellarg():\n";
$userFile = "my file.txt";
$safeFile = escapeshellarg($userFile);
echo "Escaped: $safeFile\n\n";

// 8. escapeshellcmd() — Escapes metacharacters in command
echo "Using escapeshellcmd():\n";
$rawCmd = "ls -l; rm -rf /";
$safeCmd = escapeshellcmd($rawCmd);
echo "Escaped Command: $safeCmd\n\n";

// 9. proc_open(), proc_get_status(), proc_terminate()
echo "Using proc_open():\n";
$descriptorspec = [
    0 => ["pipe", "r"],  // stdin
    1 => ["pipe", "w"],  // stdout
    2 => ["pipe", "w"]   // stderr
];

$process = proc_open("ls -l", $descriptorspec, $pipes);

if (is_resource($process)) {
    $output = stream_get_contents($pipes[1]);
    fclose($pipes[1]);

    echo "proc_open output:\n";
    echo $output;

    $status = proc_get_status($process);
    echo "\nProcess PID: " . $status['pid'] . "\n";
    echo "Running: " . ($status['running'] ? "Yes" : "No") . "\n";

    // Optional: Kill the process (if needed)
    // proc_terminate($process);

    $exitCode = proc_close($process);
    echo "Exit code: $exitCode\n";
}
*/

?>
</pre>
</body>
</html>

```

---

## 🪛 Step-by-Step Explanation

### ✅ Setting Up the Command

```php
$cmd = "id";
```

* This is a common Linux command to display user ID, group ID, and privileges.

---

## 🧰 OS Command Functions

### 1. `passthru()`

```php
passthru($cmd);
```

* Executes the command.
* Outputs raw result directly (used for binary output like PDF/images).

### 2. `system()`

```php
system($cmd);
```

* Outputs each line as it's received.
* Returns the **last line** of output.

### 3. `exec()`

```php
echo exec($cmd); // Last line only

exec($cmd, $output);
print_r($output); // Full array of lines
```

* Returns **last line** or entire result as array.

### 4. `shell_exec()`

```php
echo shell_exec($cmd);
```

* Executes and returns **entire output** as a string.

### 5. Backticks (\`)

```php
echo `id`;
```

* Short syntax for `shell_exec()`.

### 6. `popen()` and `fread()`

```php
$file = popen("id", "r");
$read = fread($file, 2096);
echo $read;
pclose($file);
```

* Opens a command stream as a file pointer.
* Use `fread()` to read result, and close with `pclose()`.

---

## ✅ Full Example with `shell_exec()`

```php
<?php
$cmd = "id";
$output = shell_exec($cmd);
echo "<pre>$output</pre>";
?>
```

---

## ✅ Best Practices

* ✅ **Always sanitize user input**

```php
$userInput = "test.txt";
$safeInput = escapeshellarg($userInput); // Add quotes
$cmd = "ls -l $safeInput";
echo shell_exec($cmd);
```

* ❌ Never run commands as `root` unless absolutely necessary.
* 🧾 Log commands in production environments.
* 🔐 Use `escapeshellarg()` and `escapeshellcmd()` to prevent injection.

---

## 📚 Summary Table

| Function       | Outputs Directly | Returns              | Notes                                 |
| -------------- | ---------------- | -------------------- | ------------------------------------- |
| `passthru()`   | ✅                | `void`               | Used for binary output                |
| `system()`     | ✅                | Last line (string)   | Outputs and returns last line         |
| `exec()`       | ❌                | Last line or array   | Use array to capture all output lines |
| `shell_exec()` | ❌                | Full output (string) | Easiest for multi-line result         |
| Backticks (\`) | ❌                | Full output (string) | Same as `shell_exec()`                |
| `popen()`      | ❌ (manual read)  | Uses fread()         | File-like pointer to output           |

---

